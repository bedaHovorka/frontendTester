services:
  # Run tests with Chromium (default)
  test-chromium:
    build: .
    volumes:
      - /home/beda/work/dummy_fe_app:/app_repo:ro  # APP_REPO (read-only)
      - /tmp/dummy_fe_app:/test_repo  # TEST_REPO (read-write, mounted to /test_repo in container)
    working_dir: /test_repo
    environment:
      - FRONTEND_TESTER_BROWSER=chromium
      - FRONTEND_TESTER_HEADLESS=true
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    command: uv run pytest -v
    networks:
      - frontend-testing

  # Run tests with Firefox
  test-firefox:
    build: .
    volumes:
      - /home/beda/work/dummy_fe_app:/app_repo:ro  # APP_REPO (read-only)
      - /tmp/dummy_fe_app:/test_repo  # TEST_REPO (read-write)
    working_dir: /test_repo
    environment:
      - FRONTEND_TESTER_BROWSER=firefox
      - FRONTEND_TESTER_HEADLESS=true
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    command: uv run pytest -v
    networks:
      - frontend-testing

  # Run tests with WebKit
  test-webkit:
    build: .
    volumes:
      - /home/beda/work/dummy_fe_app:/app_repo:ro  # APP_REPO (read-only)
      - /tmp/dummy_fe_app:/test_repo  # TEST_REPO (read-write)
    working_dir: /test_repo
    environment:
      - FRONTEND_TESTER_BROWSER=webkit
      - FRONTEND_TESTER_HEADLESS=true
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    command: uv run pytest -v
    networks:
      - frontend-testing

  # Run all browsers sequentially
  test-all:
    build: .
    volumes:
      - /home/beda/work/dummy_fe_app:/app_repo:ro  # APP_REPO (read-only)
      - /tmp/dummy_fe_app:/test_repo  # TEST_REPO (read-write)
    working_dir: /test_repo
    environment:
      - FRONTEND_TESTER_HEADLESS=true
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    command: >
      sh -c "
        FRONTEND_TESTER_BROWSER=chromium uv run pytest -v &&
        FRONTEND_TESTER_BROWSER=firefox uv run pytest -v &&
        FRONTEND_TESTER_BROWSER=webkit uv run pytest -v
      "
    networks:
      - frontend-testing

  # AI Analysis service - analyze UI and generate tests
  analyze:
    build: .
    volumes:
      - /home/beda/work/dummy_fe_app:/app_repo:ro  # APP_REPO (read-only)
      - /tmp/dummy_fe_app:/test_repo  # TEST_REPO (read-write)
    working_dir: /test_repo
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    command: uv run frontend-tester analyze http://angularjs-demo-app:3000
    networks:
      - frontend-testing

  # Test generation service - generate tests from analysis
  generate:
    build: .
    volumes:
      - /home/beda/work/dummy_fe_app:/app_repo:ro  # APP_REPO (read-only)
      - /tmp/dummy_fe_app:/test_repo  # TEST_REPO (read-write)
    working_dir: /test_repo
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    command: uv run frontend-tester generate http://angularjs-demo-app:3000 --output-dir /test_repo
    networks:
      - frontend-testing

networks:
  frontend-testing:
    external: true
    name: frontend-testing

# Usage:
# 1. Start the app: cd /home/beda/work/dummy_fe_app && docker-compose up -d
# 2. Run all browsers in parallel: docker-compose up
# 3. Run specific browser: docker-compose up test-chromium
# 4. Run all sequentially: docker-compose up test-all
#
# The test containers can access the app at: http://angularjs-demo-app:3000
